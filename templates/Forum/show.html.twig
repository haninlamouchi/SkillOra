{% extends 'frontoffice/base.html.twig' %}

{% block title %}{{ publication.titre }} - Forum{% endblock %}

{% block stylesheets %}
<style>
    .show-page { padding: 100px 0 80px; background: var(--grey-light); min-height: 100vh; }
    .show-page .container { max-width: 900px; margin: 0 auto; padding: 0 24px; }

    .show-card { background: var(--white); border-radius: var(--radius); box-shadow: var(--shadow-sm); overflow: hidden; animation: fadeUp 0.5s ease both; margin-bottom: 28px; }

    .show-id { background: rgba(255,255,255,0.15); color: rgba(255,255,255,0.7); display: inline-block; padding: 4px 14px; border-radius: var(--radius-pill); font-size: 0.8rem; font-weight: 600; margin-bottom: 12px; }
    .show-title { font-size: 1.6rem; font-weight: 800; color: var(--white); margin: 0 0 14px; line-height: 1.35; }
    .show-meta { display: flex; gap: 20px; flex-wrap: wrap; color: rgba(255,255,255,0.6); font-size: 0.88rem; }
    .show-meta span { display: inline-flex; align-items: center; gap: 6px; }

    .show-card-body { padding: 32px 36px; }
    .show-status { display: inline-flex; align-items: center; gap: 6px; padding: 6px 18px; border-radius: var(--radius-pill); font-weight: 700; font-size: 0.85rem; margin-bottom: 24px; }

    .show-media { margin-bottom: 24px; border-radius: var(--radius-sm); overflow: hidden; background: var(--grey-light); }
    .show-media img { width: 100%; max-height: 500px; object-fit: cover; display: block; }
    .show-media video { width: 100%; max-height: 500px; display: block; }

    .show-content { background: var(--grey-light); border-left: 4px solid var(--darkred); padding: 24px; border-radius: var(--radius-sm); margin-bottom: 28px; }
    .show-content h3 { font-size: 1rem; font-weight: 700; color: var(--black); margin: 0 0 14px; text-transform: uppercase; letter-spacing: 0.5px; }
    .show-content p { color: #444; font-size: 0.95rem; line-height: 1.75; margin: 0; white-space: pre-line; }

    .show-info-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 14px; margin-bottom: 28px; }
    .show-info-item { background: var(--grey-light); padding: 16px; border-radius: var(--radius-sm); }
    .show-info-item h4 { font-size: 0.78rem; font-weight: 700; color: var(--grey); text-transform: uppercase; letter-spacing: 0.5px; margin: 0 0 6px; }
    .show-info-item p { font-size: 0.92rem; color: var(--black); font-weight: 600; margin: 0; }

    .show-actions { display: flex; gap: 12px; padding-top: 24px; border-top: 1px solid var(--grey-border); flex-wrap: wrap; }
    .btn-show-act { flex: 1; min-width: 140px; padding: 12px 20px; border-radius: var(--radius-sm); font-weight: 700; font-size: 0.9rem; text-decoration: none; display: flex; align-items: center; justify-content: center; gap: 8px; transition: var(--transition); border: none; cursor: pointer; }
    .btn-show-back { background: var(--grey-light); color: var(--grey-dark); border: 1px solid var(--grey-border); }
    .btn-show-back:hover { border-color: var(--black); color: var(--black); text-decoration: none; }

    /* Comments Section */
    .comments-section { margin-top: 0; }
    .comments-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; }
    .comments-header h2 { font-size: 1.2rem; font-weight: 800; color: var(--black); margin: 0; display: flex; align-items: center; gap: 10px; }

    .comment-card {
        background: var(--white); border-radius: var(--radius-sm); padding: 20px 24px;
        margin-bottom: 14px; box-shadow: var(--shadow-sm); border: 1px solid var(--grey-border);
        transition: var(--transition); animation: fadeUp 0.4s ease both;
    }
    .comment-card:hover { box-shadow: var(--shadow-md); border-color: transparent; }

    .comment-top { display: flex; align-items: center; gap: 12px; margin-bottom: 12px; }
    .comment-avatar {
        width: 36px; height: 36px; border-radius: 50%;
        color: var(--white); display: flex; align-items: center; justify-content: center;
        font-weight: 700; font-size: 0.75rem; flex-shrink: 0;
    }
    .comment-info { flex: 1; }
    .comment-author {
        font-weight: 700; font-size: 0.88rem; color: var(--black);
        display: flex; align-items: center; gap: 8px;
    }
    .comment-author .own-badge {
        background: var(--red-light); color: var(--red); padding: 2px 8px;
        border-radius: var(--radius-pill); font-size: 0.65rem; font-weight: 700;
    }
    .comment-date { color: var(--grey); font-size: 0.78rem; margin-top: 2px; }
    .comment-body { color: #444; font-size: 0.92rem; line-height: 1.7; margin: 0 0 0 48px; white-space: pre-line; }

    .comment-actions { display: flex; gap: 8px; margin: 10px 0 0 48px; }
    .comment-actions a {
        padding: 5px 14px; border-radius: 6px; font-size: 0.78rem; font-weight: 600;
        text-decoration: none; transition: var(--transition); display: inline-flex;
        align-items: center; gap: 5px;
    }
    .btn-comment-edit { background: var(--grey-light); color: var(--grey-dark); border: 1px solid var(--grey-border); }
    .btn-comment-edit:hover { border-color: var(--black); color: var(--black); text-decoration: none; }
    .btn-comment-delete { background: var(--red-light); color: var(--red); border: 1px solid transparent; }
    .btn-comment-delete:hover { background: var(--red); color: var(--white); text-decoration: none; }

    .comment-form-card {
        background: var(--white); border-radius: var(--radius); padding: 28px 32px;
        box-shadow: var(--shadow-sm); border: 1px solid var(--grey-border); margin-bottom: 28px;
    }
    .comment-form-card h3 {
        font-size: 1rem; font-weight: 700; color: var(--black); margin: 0 0 18px;
        display: flex; align-items: center; gap: 8px;
    }
    .comment-form-card h3 i { color: var(--darkred); }
    .comment-form-card textarea {
        width: 100%; padding: 14px 18px; border: 2px solid var(--grey-border);
        border-radius: var(--radius-sm); font-size: 0.92rem; font-family: inherit;
        resize: vertical; min-height: 100px; transition: var(--transition);
        background: var(--grey-light); color: var(--black);
    }
    .comment-form-card textarea:focus { outline: none; border-color: var(--red); background: var(--white); box-shadow: 0 0 0 4px rgba(231,76,60,0.1); }
    .comment-form-card .btn-submit { margin-top: 12px; }
    .comment-form-card .form-error { color: var(--red); font-size: 0.8rem; margin-top: 6px; }

    .visitor-notice {
        background: var(--white); border-left: 4px solid var(--darkred);
        border-radius: var(--radius-sm); padding: 18px 24px;
        box-shadow: var(--shadow-sm); margin-bottom: 28px;
    }
    .visitor-notice p { margin: 0; color: var(--grey-dark); font-size: 0.9rem; line-height: 1.6; }
    .visitor-notice code {
        background: var(--grey-light); padding: 2px 8px; border-radius: 4px;
        font-size: 0.85rem; color: var(--red-dark); font-weight: 600;
    }

    .no-comments {
        text-align: center; padding: 40px 20px; background: var(--white);
        border-radius: var(--radius-sm); box-shadow: var(--shadow-sm); margin-bottom: 20px;
    }
    .no-comments i { font-size: 2.5rem; color: var(--grey-border); margin-bottom: 12px; display: block; }
    .no-comments p { color: var(--grey); font-size: 0.95rem; margin: 0; }

    @media (max-width: 768px) {
        .show-page { padding: 80px 0 40px; }
        .show-card-header, .show-card-body { padding: 24px 20px; }
        .show-meta { flex-direction: column; gap: 8px; }
        .comment-body, .comment-actions { margin-left: 0; }
        .comment-form-card { padding: 20px; }
    }
</style>
{% endblock %}

{% block body %}
<section class="show-page">
    <div class="container">

        {% for label, messages in app.flashes %}
            {% for message in messages %}
                <div class="flash-msg {{ label }}">
                    <i class="fas fa-{{ label == 'success' ? 'check-circle' : 'exclamation-circle' }}"></i>
                    {{ message }}
                </div>
            {% endfor %}
        {% endfor %}

        <div class="show-card">
            <div class="show-card-header">
                <span class="show-badge">{{ publication.typecontenu.label }}</span>
                <div class="show-id"><i class="fas fa-hashtag"></i> Publication #{{ publication.id }}</div>
                <h1 class="show-title">{{ publication.titre }}</h1>
                <div class="show-meta">
                    <span><i class="far fa-calendar-alt"></i> {{ publication.datePublication|date('d/m/Y H:i') }}</span>
                    <span><i class="far fa-user"></i> {{ publication.user.prenom }} {{ publication.user.nom }}</span>
                    <span><i class="far fa-comment"></i> {{ publication.commentaires|length }} comment(s)</span>
                </div>
            </div>

            <div class="show-card-body">
                <span class="show-status {{ publication.status.value == 'publié' ? 'published' : 'pending' }}">
                    <i class="fas fa-{{ publication.status.value == 'publié' ? 'check-circle' : 'clock' }}"></i>
                    {{ publication.status.value == 'publié' ? 'Published' : 'Pending' }}
                </span>

                {% if publication.fichier %}
                    <div class="show-media">
                        {% set ext = publication.fichier|split('.')|last|lower %}
                        {% if ext in ['jpg','jpeg','png','gif','webp'] %}
                            <img src="{{ asset('uploads/publications/' ~ publication.fichier) }}" alt="{{ publication.titre }}">
                        {% elseif ext in ['mp4','webm','ogg'] %}
                            <video controls><source src="{{ asset('uploads/publications/' ~ publication.fichier) }}" type="video/{{ ext }}"></video>
                        {% endif %}
                    </div>
                {% endif %}

                <div class="show-content">
                    <h3><i class="fas fa-align-left" style="margin-right:6px;"></i> Content</h3>
                    <p>{{ publication.contenu }}</p>
                </div>

                <div class="show-info-grid">
                    <div class="show-info-item">
                        <h4><i class="fas fa-tag"></i> Content Type</h4>
                        <p>{{ publication.typecontenu.label }}</p>
                    </div>
                    <div class="show-info-item">
                        <h4><i class="fas fa-info-circle"></i> Status</h4>
                        <p>{{ publication.status.label }}</p>
                    </div>
                    <div class="show-info-item">
                        <h4><i class="far fa-calendar"></i> Date</h4>
                        <p>{{ publication.datePublication|date('d/m/Y') }}</p>
                    </div>
                    {% if publication.fichier %}
                    <div class="show-info-item">
                        <h4><i class="fas fa-file"></i> File</h4>
                        <p>{{ publication.fichier|split('-')|last }}</p>
                    </div>
                    {% endif %}
                </div>

                <div class="show-actions">
                    <a href="{{ path('app_forum_index') }}{% if currentUser %}?u={{ currentUser.id }}{% endif %}" class="btn-show-act btn-show-back">
                        <i class="fas fa-arrow-left"></i> Back to Forum
                    </a>
                </div>
            </div>
        </div>

        {% if commentForm %}
            <div class="comment-form-card">
                <h3><i class="fas fa-pen"></i> Add a Comment</h3>
{{ form_start(commentForm, {'action': path('app_forum_show', {id: publication.id}) ~ '?u=' ~ currentUser.id, 'attr': {'novalidate': 'novalidate'}}) }}
                    {{ form_errors(commentForm) }}
                    <div>
                        {{ form_widget(commentForm.contenu, {'attr': {
                            'placeholder': 'Write your comment here...',
                            'class': 'form-control',
                            'rows': 4
                        }}) }}
                        {% if commentForm.contenu.vars.errors|length > 0 %}
                            {% for error in commentForm.contenu.vars.errors %}
                                <div class="form-error"><i class="fas fa-exclamation-triangle"></i> {{ error.message }}</div>
                            {% endfor %}
                        {% endif %}
                    </div>
                    <button type="submit" class="btn-submit"><i class="fas fa-paper-plane"></i> Post Comment</button>
                {{ form_end(commentForm) }}
            </div>
        {% endif %}

        <div class="comments-section">
            <div class="comments-header">
                <h2><i class="far fa-comments" style="color:var(--darkred);"></i> Comments <span class="comments-count">{{ publication.commentaires|length }}</span></h2>
            </div>

            {% if publication.commentaires|length == 0 %}
                <div class="no-comments">
                    <i class="far fa-comment-dots"></i>
                    <p>No comments yet. Be the first to share your thoughts!</p>
                </div>
            {% else %}
                {% for comment in publication.commentaires %}
                    <div class="comment-card {% if currentUser and comment.user.id == currentUser.id %}own-comment{% endif %}" style="animation-delay: {{ loop.index0 * 0.05 }}s;">
                        <div class="comment-top">
                            <div class="comment-avatar {% if currentUser and comment.user.id == currentUser.id %}own{% endif %}">
                                {{ comment.user.prenom|slice(0,1)|upper }}{{ comment.user.nom|slice(0,1)|upper }}
                            </div>
                            <div class="comment-info">
                                <div class="comment-author">
                                    {{ comment.user.prenom }} {{ comment.user.nom }}
                                    {% if currentUser and comment.user.id == currentUser.id %}
                                        <span class="own-badge">YOU</span>
                                    {% endif %}
                                </div>
                                <div class="comment-date">{{ comment.dateCommentaire|date('d/m/Y H:i') }}</div>
                            </div>
                        </div>
                        <div class="comment-body">{{ comment.contenu }}</div>

                        {% if currentUser and comment.user.id == currentUser.id %}
                            <div class="comment-actions">
                                <a href="{{ path('app_forum_commentaire_edit', {commentaireId: comment.id}) }}?u={{ currentUser.id }}" class="btn-comment-edit">
                                    <i class="far fa-edit"></i> Edit
                                </a>
                                <a href="{{ path('app_forum_commentaire_delete', {commentaireId: comment.id}) }}?u={{ currentUser.id }}" class="btn-comment-delete" onclick="return confirm('Are you sure you want to delete this comment?')">
                                    <i class="far fa-trash-alt"></i> Delete
                                </a>
                            </div>
                        {% endif %}
                    </div>
                {% endfor %}
            {% endif %}
        </div>

    </div>
</section>
{% endblock %}