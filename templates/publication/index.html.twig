{% extends 'frontoffice/base.html.twig' %}

{% block title %}My Publications{% endblock %}

{% block stylesheets %}
<style>
    .pub-page { padding: 100px 0 80px; background: var(--grey-light); min-height: 100vh; }
    .pub-page .container { max-width: 1140px; margin: 0 auto; padding: 0 24px; }

    .page-hero { display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 20px; }

    .results-info { display: flex; align-items: center; justify-content: space-between; margin-bottom: 18px; padding: 0 4px; }
    .results-info span { color: var(--grey); font-size: 0.88rem; }
    .results-info strong { color: var(--darkred); font-weight: 800; font-size: 1.15rem; }

    .pub-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(340px, 1fr)); gap: 22px; margin-bottom: 40px; }

    .pub-card {
        background: var(--white); border-radius: var(--radius); overflow: hidden;
        box-shadow: var(--shadow-sm); border: 1px solid var(--grey-border);
        transition: var(--transition); position: relative; display: flex; flex-direction: column;
        animation: cardIn 0.5s cubic-bezier(0.4, 0, 0.2, 1) both;
    }
    .pub-card:hover { transform: translateY(-6px); box-shadow: var(--shadow-lg); border-color: transparent; }
    .pub-card.hidden { display: none; }
    .pub-card:nth-child(2) { animation-delay: 0.06s; }
    .pub-card:nth-child(3) { animation-delay: 0.12s; }
    .pub-card:nth-child(4) { animation-delay: 0.18s; }
    .pub-card:nth-child(5) { animation-delay: 0.24s; }
    .pub-card:nth-child(6) { animation-delay: 0.3s; }

    .pub-card-media { height: 200px; overflow: hidden; background: var(--grey-light); position: relative; }
    .pub-card-media img { width: 100%; height: 100%; object-fit: cover; transition: transform 0.5s cubic-bezier(0.4, 0, 0.2, 1); }
    .pub-card:hover .pub-card-media img { transform: scale(1.08); }
    .pub-card-media video { width: 100%; height: 100%; object-fit: cover; }
    .pub-card-media .no-media {
        width: 100%; height: 100%; display: flex; align-items: center; justify-content: center;
        background: linear-gradient(135deg, var(--darkred), var(--darkred-deep)); color: rgba(255,255,255,0.08); font-size: 4rem;
    }
    .pub-card-media::after { content: ''; position: absolute; bottom: 0; left: 0; right: 0; height: 60px; background: linear-gradient(transparent, rgba(0,0,0,0.15)); pointer-events: none; }

    .pub-card-badges { position: absolute; top: 12px; left: 12px; right: 12px; display: flex; justify-content: space-between; align-items: flex-start; pointer-events: none; z-index: 2; }
    .badge-status { padding: 5px 14px; border-radius: var(--radius-pill); font-size: 0.72rem; font-weight: 700; }

    .pub-card-body { padding: 22px 22px 18px; flex: 1; display: flex; flex-direction: column; }
    .pub-card-title { font-size: 1.05rem; font-weight: 700; color: var(--black); margin: 0 0 10px; line-height: 1.45; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
    .pub-card-meta { display: flex; align-items: center; gap: 14px; flex-wrap: wrap; color: var(--grey); font-size: 0.78rem; margin-bottom: 14px; }
    .pub-card-meta span { display: inline-flex; align-items: center; gap: 5px; }
    .pub-card-excerpt { color: #555; font-size: 0.87rem; line-height: 1.65; margin-bottom: 18px; flex: 1; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; }

    .pub-card-footer { display: flex; gap: 8px; padding-top: 16px; border-top: 1px solid var(--grey-border); }
    .pub-card-footer a {
        flex: 1; padding: 10px 0; border-radius: var(--radius-sm); text-decoration: none;
        font-size: 0.8rem; font-weight: 600; text-align: center; transition: var(--transition);
        display: inline-flex; align-items: center; justify-content: center; gap: 6px;
    }

    @media (max-width: 768px) {
        .pub-page { padding: 80px 0 40px; }
        .page-hero { flex-direction: column; align-items: flex-start; }
        .pub-grid { grid-template-columns: 1fr; }
    }
</style>
{% endblock %}

{% block body %}
<section class="pub-page">
    <div class="container">

        <div class="page-hero">
            <div class="page-hero-left">
                <h1>My Publications</h1>
                <p>Manage and track your publications</p>
            </div>
<a href="{{ path('app_publication_new', {id: currentUser.id}) }}" class="btn-new">
                <i class="fas fa-plus"></i> New Publication
            </a>
        </div>

        <div class="search-bar">
            <input type="text" id="searchInput" placeholder="Search by title or content...">
            <select id="filterType">
                <option value="">All Types</option>
                <option value="image">Image</option>
                <option value="video">Video</option>
                <option value="texte">Text</option>
            </select>
            <select id="filterStatus">
                <option value="">All Statuses</option>
                <option value="en attente">Pending</option>
                <option value="publié">Published</option>
            </select>
            <button class="btn-reset" id="btnReset"><i class="fas fa-redo"></i> Reset</button>
        </div>

        <div class="results-info">
            <span><strong id="resultsCount">{{ publications|length }}</strong> publication(s)</span>
        </div>

        {% if publications is not empty %}
            <div class="pub-grid" id="publicationsGrid">
                {% for publication in publications %}
                    <div class="pub-card"
                         data-title="{{ publication.titre|lower }}"
                         data-content="{{ publication.contenu|lower }}"
                         data-type="{{ publication.typecontenu.value }}"
                         data-status="{{ publication.status.value }}"
                         data-date="{{ publication.datePublication|date('Y-m-d') }}">

                        <div class="pub-card-media">
                            {% if publication.fichier %}
                                {% set ext = publication.fichier|split('.')|last|lower %}
                                {% if ext in ['jpg','jpeg','png','gif','webp'] %}
                                    <img src="{{ asset('uploads/publications/' ~ publication.fichier) }}" alt="{{ publication.titre }}" loading="lazy">
                                {% elseif ext in ['mp4','webm','ogg'] %}
                                    <video muted><source src="{{ asset('uploads/publications/' ~ publication.fichier) }}" type="video/{{ ext }}"></video>
                                {% else %}
                                    <div class="no-media"><i class="fas fa-file-alt"></i></div>
                                {% endif %}
                            {% else %}
                                <div class="no-media"><i class="fas fa-pen-nib"></i></div>
                            {% endif %}
                            <div class="pub-card-badges">
                                <span class="badge-type">{{ publication.typecontenu.label }}</span>
                                <span class="badge-status {{ publication.status.value == 'publié' ? 'published' : 'pending' }}">
                                    {{ publication.status.label }}
                                </span>
                            </div>
                        </div>

                        <div class="pub-card-body">
                            <h3 class="pub-card-title">{{ publication.titre }}</h3>
                            <div class="pub-card-meta">
                                <span><i class="far fa-calendar"></i> {{ publication.datePublication|date('d/m/Y') }}</span>
                                <span><i class="far fa-user"></i> {{ publication.user.prenom }} {{ publication.user.nom }}</span>
                                <span><i class="far fa-comment"></i> {{ publication.commentaires|length }}</span>
                            </div>
                            <p class="pub-card-excerpt">{{ publication.contenu|slice(0, 120) }}{% if publication.contenu|length > 120 %}...{% endif %}</p>
                            <div class="pub-card-footer">
                                <a href="{{ path('app_publication_show', {id: publication.id, u: currentUser.id}) }}" class="btn-show"><i class="fas fa-eye"></i> View</a>
                                <a href="{{ path('app_publication_edit', {id: publication.id, u: currentUser.id}) }}" class="btn-edit"><i class="fas fa-pen"></i> Edit</a>
                                <a href="{{ path('app_publication_delete', {id: publication.id, u: currentUser.id}) }}" class="btn-del" onclick="return confirm('Delete this publication?')"><i class="fas fa-trash"></i></a>
                            </div>
                        </div>
                    </div>
                {% endfor %}
            </div>
        {% else %}
            <div class="empty-state">
                <div class="empty-state-icon"><i class="fas fa-inbox"></i></div>
                <h3>No publications yet</h3>
                <p>Start by creating your first publication</p>
                <a href="{{ path('app_publication_new', {id: currentUser.id}) }}" class="btn-new"><i class="fas fa-plus"></i> Create a Publication</a>
            </div>
        {% endif %}
    </div>
</section>
{% endblock %}

{% block javascripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    var searchInput = document.getElementById('searchInput');
    var filterType = document.getElementById('filterType');
    var filterStatus = document.getElementById('filterStatus');
    var btnReset = document.getElementById('btnReset');
    var resultsCount = document.getElementById('resultsCount');

    function performSearch() {
        var term = searchInput.value.toLowerCase().trim();
        var type = filterType.value;
        var status = filterStatus.value;
        var cards = document.querySelectorAll('.pub-card');
        var count = 0;
        cards.forEach(function(card) {
            var title = card.getAttribute('data-title') || '';
            var content = card.getAttribute('data-content') || '';
            var cType = card.getAttribute('data-type') || '';
            var cStatus = card.getAttribute('data-status') || '';
            var matchSearch = !term || title.indexOf(term) !== -1 || content.indexOf(term) !== -1;
            var matchType = !type || cType === type;
            var matchStatus = !status || cStatus === status;
            if (matchSearch && matchType && matchStatus) { card.classList.remove('hidden'); count++; }
            else { card.classList.add('hidden'); }
        });
        resultsCount.textContent = count;
    }
    searchInput.addEventListener('input', performSearch);
    filterType.addEventListener('change', performSearch);
    filterStatus.addEventListener('change', performSearch);
    btnReset.addEventListener('click', function() {
        searchInput.value = ''; filterType.value = ''; filterStatus.value = '';
        performSearch();
    });
});
</script>
{% endblock %}