{% extends 'backoffice/base.html.twig' %}

{% block title %}Forum Management — Publications{% endblock %}

{% block stylesheets %}
<style>
    :root {
        --sk-primary: #131212;
        --sk-primary-dark: #040404;
        --sk-primary-light: #1e1d1d;
    }

    .page-header { margin-bottom: 1.5rem; }
    .page-header h3 { font-size: 1.5rem; font-weight: 700; color: #bf0000; }
    .page-header .badge-count {
        background: #bf0000; color: #fff; font-size: .85rem;
        padding: .35em .75em; border-radius: 50px; margin-left: .5rem; vertical-align: middle;
    }

    /* Tabs */
    .forum-tabs { display: flex; gap: 0; margin-bottom: 1.5rem; }
    .forum-tab {
        padding: .7rem 1.6rem; font-weight: 600; font-size: .9rem; text-decoration: none;
        border: 2px solid #eee; color: #666; background: #fafafa; transition: all .2s;
    }
    .forum-tab:first-child { border-radius: 10px 0 0 10px; }
    .forum-tab:last-child  { border-radius: 0 10px 10px 0; }
    .forum-tab.active { background: var(--sk-primary); color: #fff; border-color: var(--sk-primary); }
    .forum-tab:not(.active):hover { background: #f0f0f0; color: #333; }

    .pub-card { border: none; border-radius: 12px; box-shadow: 0 2px 12px rgba(0,0,0,.06); }
    .pub-card .card-body { padding: 0; }

    .pub-table { width: 100%; border-collapse: separate; border-spacing: 0; font-size: .875rem; }
    .pub-table thead th {
        background: linear-gradient(135deg, var(--sk-primary), var(--sk-primary-light));
        color: #fff; font-weight: 600; padding: .85rem 1rem; white-space: nowrap;
        border: none; text-transform: uppercase; font-size: .75rem; letter-spacing: .5px;
    }
    .pub-table thead th:first-child { border-radius: 12px 0 0 0; }
    .pub-table thead th:last-child  { border-radius: 0 12px 0 0; }
    .pub-table tbody tr { transition: background .15s; }
    .pub-table tbody tr:hover { background: #fdf2f2; }
    .pub-table tbody td {
        padding: .75rem 1rem; vertical-align: middle;
        border-bottom: 1px solid #f0f0f0; color: #333;
    }
    .pub-table tbody tr:last-child td { border-bottom: none; }

    .pub-thumb {
        width: 50px; height: 50px; border-radius: 8px; object-fit: cover;
        cursor: pointer; border: 2px solid #eee; transition: border-color .2s, transform .2s;
    }
    .pub-thumb:hover { border-color: var(--sk-primary); transform: scale(1.08); }
    .pub-thumb-placeholder {
        width: 50px; height: 50px; border-radius: 8px; background: #f5f5f5;
        display: flex; align-items: center; justify-content: center; color: #bbb; font-size: 1.2rem;
    }

    .badge-publie { background: #d4edda; color: #155724; font-weight: 600; padding: .3em .7em; border-radius: 20px; font-size: .78rem; }
    .badge-attente { background: #fff3cd; color: #856404; font-weight: 600; padding: .3em .7em; border-radius: 20px; font-size: .78rem; }
    .badge-type { padding: .3em .65em; border-radius: 20px; font-size: .75rem; font-weight: 600; }
    .badge-type-image { background: #e8f4fd; color: #0c5460; }
    .badge-type-video { background: #f3e5f5; color: #6a1b9a; }
    .badge-type-texte { background: #f0f0f0; color: #555; }
    .badge-role { padding: .25em .6em; border-radius: 20px; font-size: .7rem; font-weight: 600; margin-left: .3rem; vertical-align: middle; }
    .badge-role-etudiant { background: #e3f2fd; color: #1565c0; }
    .badge-role-rc { background: #fce4ec; color: #c62828; }
    .badge-role-admin { background: #f3e5f5; color: #6a1b9a; }
    .btn-action {
        width: 34px; height: 34px; border-radius: 8px;
        display: inline-flex; align-items: center; justify-content: center;
        border: none; font-size: .9rem; transition: transform .15s, box-shadow .15s; cursor: pointer;
    }
    .btn-action:hover { transform: translateY(-2px); box-shadow: 0 3px 8px rgba(0,0,0,.15); }
    .btn-view   { background: var(--sk-primary); color: #fff; }
    .btn-view:hover   { background: var(--sk-primary-dark); color: #fff; }
    .btn-edit   { background: #f0ad4e; color: #fff; }
    .btn-edit:hover   { background: #d9952b; color: #fff; }
    .btn-delete { background: #dc3545; color: #fff; }
    .btn-delete:hover { background: #b02a37; color: #fff; }

    .contenu-preview {
        max-width: 220px; white-space: nowrap; overflow: hidden;
        text-overflow: ellipsis; color: #666; font-size: .82rem;
    }

    .empty-state { text-align: center; padding: 4rem 2rem; color: #999; }
    .empty-state i { font-size: 3rem; margin-bottom: 1rem; color: #ddd; }

    /* ── Search & Sort toolbar ── */
    .forum-toolbar {
        display: flex; align-items: center; gap: 1rem; margin-bottom: 1.2rem; flex-wrap: wrap;
    }
    .forum-toolbar .search-box {
        flex: 1; min-width: 220px; position: relative;
    }
    .forum-toolbar .search-box input[type="search"] {
        width: 100%; border: 2px solid #eee; border-radius: 10px; padding: .6rem 1rem .6rem 2.5rem;
        font-size: .88rem; transition: border-color .2s; background: #fff;
    }
    .forum-toolbar .search-box input[type="search"]:focus {
        border-color: #bf0000; box-shadow: 0 0 0 3px rgba(191,0,0,.08); outline: none;
    }
    .forum-toolbar .search-box > i {
        position: absolute; left: .85rem; top: 50%; transform: translateY(-50%);
        color: #aaa; font-size: 1rem; pointer-events: none; z-index: 2;
    }
    .forum-toolbar .search-box .clear-search {
        position: absolute; right: .6rem; top: 50%; transform: translateY(-50%);
        background: none; border: none; color: #bbb; font-size: 1.1rem; cursor: pointer;
        display: none; padding: 0; line-height: 1;
    }
    .forum-toolbar .search-box .clear-search.visible { display: block; }
    .forum-toolbar .search-box .clear-search:hover { color: #bf0000; }
    .forum-toolbar .sort-group {
        display: flex; align-items: center; gap: .5rem;
    }
    .forum-toolbar .sort-group label {
        font-size: .8rem; font-weight: 600; color: #888; text-transform: uppercase; letter-spacing: .5px;
        white-space: nowrap; margin: 0;
    }
    .forum-toolbar .sort-group select {
        border: 2px solid #eee; border-radius: 8px; padding: .45rem .8rem;
        font-size: .85rem; background: #fff; cursor: pointer; transition: border-color .2s;
        color: #333;
    }
    .forum-toolbar .sort-group select:focus { border-color: #bf0000; outline: none; }
    .forum-toolbar .sort-dir-btn {
        background: var(--sk-primary); color: #fff; border: none; border-radius: 8px;
        width: 36px; height: 36px; display: flex; align-items: center; justify-content: center;
        cursor: pointer; font-size: 1rem; transition: background .2s;
    }
    .forum-toolbar .sort-dir-btn:hover { background: #bf0000; }
    .search-results-info {
        font-size: .82rem; color: #888; margin-bottom: .8rem;
    }
    .search-results-info strong { color: #bf0000; }
    .search-results-info a { color: #bf0000; text-decoration: none; font-weight: 600; }
    .search-results-info a:hover { text-decoration: underline; }

    /* Overlays */
    .media-overlay {
        display: none; position: fixed; inset: 0; background: rgba(0,0,0,.85);
        z-index: 99999; align-items: center; justify-content: center; padding: 2rem;
    }
    .media-overlay.active { display: flex; }
    .media-overlay-close {
        position: absolute; top: 1.2rem; right: 1.5rem; background: none; border: none;
        color: #fff; font-size: 2rem; cursor: pointer; z-index: 100000; line-height: 1; opacity: .8;
    }
    .media-overlay-close:hover { opacity: 1; }
    .media-overlay img, .media-overlay video {
        max-width: 90vw; max-height: 85vh; border-radius: 10px; box-shadow: 0 8px 40px rgba(0,0,0,.5);
    }
    .media-overlay-title {
        position: absolute; bottom: 1.5rem; left: 50%; transform: translateX(-50%);
        color: #fff; font-size: 1rem; font-weight: 600; background: rgba(0,0,0,.55);
        padding: .4em 1.2em; border-radius: 30px; white-space: nowrap;
    }

    .confirm-overlay {
        display: none; position: fixed; inset: 0; background: rgba(0,0,0,.6);
        z-index: 99999; align-items: center; justify-content: center;
    }
    .confirm-overlay.active { display: flex; }
    .confirm-box {
        background: #fff; border-radius: 14px; padding: 2rem 2.5rem; text-align: center;
        box-shadow: 0 12px 40px rgba(0,0,0,.25); max-width: 380px; width: 90%;
    }
    .confirm-box i { font-size: 2.5rem; color: #dc3545; margin-bottom: .8rem; }
    .confirm-box h5 { font-weight: 700; margin-bottom: .5rem; }
    .confirm-box p { color: #666; font-size: .9rem; margin-bottom: 1.5rem; }
    .confirm-box .btn-cancel {
        background: #f0f0f0; color: #333; border: none; padding: .5rem 1.5rem;
        border-radius: 8px; font-weight: 600; margin-right: .5rem; cursor: pointer;
    }
    .confirm-box .btn-confirm-delete {
        background: #dc3545; color: #fff; border: none; padding: .5rem 1.5rem;
        border-radius: 8px; font-weight: 600; cursor: pointer; text-decoration: none; display: inline-block;
    }
    .confirm-box .btn-confirm-delete:hover { background: #b02a37; }

    .edit-overlay {
        display: none; position: fixed; inset: 0; background: rgba(0,0,0,.6);
        z-index: 99998; align-items: center; justify-content: center; padding: 2rem;
    }
    .edit-overlay.active { display: flex; }
    .edit-box {
        background: #fff; border-radius: 14px; box-shadow: 0 12px 40px rgba(0,0,0,.25);
        max-width: 620px; width: 95%; max-height: 90vh; overflow-y: auto;
    }
    .edit-box-header {
        display: flex; align-items: center; justify-content: space-between;
        padding: 1.2rem 1.8rem; border-bottom: 1px solid #eee;
    }
    .edit-box-header h5 { font-weight: 700; margin: 0; color: #bf0000; }
    .edit-box-header .close-edit {
        background: none; border: none; font-size: 1.4rem; cursor: pointer; color: #999;
    }
    .edit-box-header .close-edit:hover { color: #333; }
    .edit-box-body { padding: 1.5rem 1.8rem; }
    .edit-box-body .form-group { margin-bottom: 1.2rem; }
    .edit-box-body label {
        display: block; font-weight: 600; font-size: .85rem; margin-bottom: .35rem; color: #333;
    }
    .edit-box-body .form-control {
        border: 1px solid #ddd; border-radius: 8px; padding: .55rem .85rem;
        font-size: .9rem; transition: border-color .2s; width: 100%;
    }
    .edit-box-body .form-control:focus { border-color: #bf0000; box-shadow: 0 0 0 3px rgba(191,0,0,.1); outline: none; }
    .edit-box-body textarea.form-control { resize: vertical; min-height: 100px; }
    .edit-box-body .current-file {
        display: flex; align-items: center; gap: .6rem; margin-bottom: .5rem;
        padding: .5rem .8rem; background: #f9f9f9; border-radius: 8px; font-size: .82rem; color: #555;
    }
    .edit-box-body .current-file i { color: #bf0000; font-size: 1rem; }
    .edit-box-body .current-file img { width: 40px; height: 40px; object-fit: cover; border-radius: 6px; }
    .edit-box-footer {
        display: flex; justify-content: flex-end; gap: .6rem;
        padding: 1rem 1.8rem; border-top: 1px solid #eee;
    }
    .edit-box-footer .btn-cancel-edit {
        background: #f0f0f0; color: #333; border: none; padding: .5rem 1.4rem;
        border-radius: 8px; font-weight: 600; cursor: pointer;
    }
    .edit-box-footer .btn-save-edit {
        background: #bf0000; color: #fff; border: none; padding: .5rem 1.4rem;
        border-radius: 8px; font-weight: 600; cursor: pointer; transition: background .2s;
    }
    .edit-box-footer .btn-save-edit:hover { background: #960000; }

    @media (max-width: 768px) {
        .pub-table thead { display: none; }
        .pub-table tbody tr {
            display: block; margin-bottom: 1rem; border: 1px solid #eee;
            border-radius: 10px; padding: .75rem;
        }
        .pub-table tbody td {
            display: flex; justify-content: space-between; align-items: center;
            padding: .4rem .5rem; border-bottom: 1px solid #f8f8f8;
        }
        .pub-table tbody td::before {
            content: attr(data-label); font-weight: 600; color: var(--sk-primary);
            margin-right: 1rem; font-size: .78rem; text-transform: uppercase;
        }
        .forum-toolbar { flex-direction: column; align-items: stretch; }
        .forum-toolbar .sort-group { justify-content: flex-start; }
    }
</style>
{% endblock %}

{% block body %}
<div class="page-header d-flex align-items-center justify-content-between">
    <div>
        <h3>
            <i class="mdi mdi-forum-outline"></i>
            Forum Management — Publications
        </h3>
    </div>
</div>

{# ── Tabs ── #}
<div class="forum-tabs">
    <a href="{{ path('admin_forum_publications') }}" class="forum-tab active">
        <i class="mdi mdi-file-document-outline"></i> Publications
        <span class="badge-count">{{ publications|length }}</span>
    </a>
    <a href="{{ path('admin_forum_commentaires') }}" class="forum-tab">
        <i class="mdi mdi-comment-text-outline"></i> Commentaires
    </a>
</div>

{# ── Search & Sort Toolbar ── #}
<div class="forum-toolbar">
    <div class="search-box">
        <i class="mdi mdi-magnify"></i>
        <form id="pubSearchForm" method="get" action="{{ path('admin_forum_publications') }}" style="margin:0;">
            <input type="hidden" name="sort" value="{{ sort }}">
            <input type="hidden" name="dir" value="{{ dir }}">
            <input type="search" name="q" value="{{ search }}" placeholder="Rechercher par titre, contenu, auteur..."
                   id="pubSearchInput" autocomplete="off">
            <button type="button" class="clear-search {{ search ? 'visible' }}" onclick="clearSearch()">&times;</button>
        </form>
    </div>
    <div class="sort-group">
        <label>Trier par</label>
        <select id="pubSortSelect" onchange="applySort()">
            <option value="datePublication" {{ sort == 'datePublication' ? 'selected' }}>Date</option>
            <option value="titre" {{ sort == 'titre' ? 'selected' }}>Titre</option>
            <option value="auteur" {{ sort == 'auteur' ? 'selected' }}>Auteur</option>
            <option value="status" {{ sort == 'status' ? 'selected' }}>Statut</option>
            <option value="typecontenu" {{ sort == 'typecontenu' ? 'selected' }}>Type</option>
            <option value="id" {{ sort == 'id' ? 'selected' }}>ID</option>
        </select>
        <button class="sort-dir-btn" id="pubDirBtn" onclick="toggleDir()" title="Changer l'ordre">
            <i class="mdi mdi-sort-{{ dir == 'ASC' ? 'ascending' : 'descending' }}"></i>
        </button>
    </div>
</div>

{% if search %}
<div class="search-results-info">
    <i class="mdi mdi-information-outline"></i>
    <strong>{{ publications|length }}</strong> résultat(s) pour « <strong>{{ search }}</strong> »
    — <a href="{{ path('admin_forum_publications') }}">Effacer la recherche</a>
</div>
{% endif %}

<div class="card pub-card">
    <div class="card-body">
        {% if publications is empty %}
            <div class="empty-state">
                <i class="mdi mdi-file-remove-outline"></i>
                <h5>Aucune publication</h5>
                <p>{% if search %}Aucun résultat pour « {{ search }} ».{% else %}Il n'y a aucune publication pour le moment.{% endif %}</p>
            </div>
        {% else %}
            <div class="table-responsive">
                <table class="pub-table">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Aperçu</th>
                            <th>Titre</th>
                            <th>Contenu</th>
                            <th>Auteur</th>
                            <th>Type</th>
                            <th>Statut</th>
                            <th>Date</th>
                            <th>Commentaires</th>
                            <th style="text-align:center">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for pub in publications %}
                        <tr>
                            <td data-label="ID">{{ pub.id }}</td>
                            <td data-label="Aperçu">
                                {% if pub.typecontenu.value == 'image' and pub.fichier %}
                                    <img src="{{ asset('uploads/publications/' ~ pub.fichier) }}"
                                         class="pub-thumb" alt="{{ pub.titre }}"
                                         onclick="openMedia('image', '{{ asset('uploads/publications/' ~ pub.fichier) }}', '{{ pub.titre|e('js') }}')">
                                {% elseif pub.typecontenu.value == 'video' and pub.fichier %}
                                    <div class="pub-thumb-placeholder" style="cursor:pointer"
                                         onclick="openMedia('video', '{{ asset('uploads/publications/' ~ pub.fichier) }}', '{{ pub.titre|e('js') }}')">
                                        <i class="mdi mdi-play-circle-outline"></i>
                                    </div>
                                {% else %}
                                    <div class="pub-thumb-placeholder">
                                        <i class="mdi mdi-text-box-outline"></i>
                                    </div>
                                {% endif %}
                            </td>
                            <td data-label="Titre"><strong>{{ pub.titre }}</strong></td>
                            <td data-label="Contenu">
                                <div class="contenu-preview" title="{{ pub.contenu }}">{{ pub.contenu }}</div>
                            </td>
                            <td data-label="Auteur">
                                {{ pub.user.prenom }} {{ pub.user.nom }}
                                {% if pub.user.role == 'etudiant' %}
                                    <span class="badge-role badge-role-etudiant">Étudiant</span>
                                {% elseif pub.user.role == 'responsable_club' %}
                                    <span class="badge-role badge-role-rc">Resp. Club</span>
                                {% elseif pub.user.role == 'admin' %}
                                    <span class="badge-role badge-role-admin">Admin</span>
                                {% endif %}
                            </td>
                            <td data-label="Type">
                                {% if pub.typecontenu.value == 'image' %}
                                    <span class="badge-type badge-type-image"><i class="mdi mdi-image-outline"></i> Image</span>
                                {% elseif pub.typecontenu.value == 'video' %}
                                    <span class="badge-type badge-type-video"><i class="mdi mdi-video-outline"></i> Vidéo</span>
                                {% else %}
                                    <span class="badge-type badge-type-texte"><i class="mdi mdi-text-box-outline"></i> Texte</span>
                                {% endif %}
                            </td>
                            <td data-label="Statut">
                                {% if pub.status.value == 'publié' %}
                                    <span class="badge-publie">Publié</span>
                                {% else %}
                                    <span class="badge-attente">En attente</span>
                                {% endif %}
                            </td>
                            <td data-label="Date">{{ pub.datePublication|date('d/m/Y H:i') }}</td>
                            <td data-label="Commentaires" style="text-align:center">
                                <strong>{{ pub.commentaires|length }}</strong>
                            </td>
                            <td data-label="Actions" style="text-align:center; white-space:nowrap;">
                                {% if pub.fichier and pub.typecontenu.value in ['image', 'video'] %}
                                    <button class="btn-action btn-view" title="Voir le média"
                                            onclick="openMedia('{{ pub.typecontenu.value }}', '{{ asset('uploads/publications/' ~ pub.fichier) }}', '{{ pub.titre|e('js') }}')">
                                        <i class="mdi mdi-eye-outline"></i>
                                    </button>
                                {% endif %}
                                <button class="btn-action btn-edit" title="Modifier"
                                        onclick="openEdit({{ pub.id }})">
                                    <i class="mdi mdi-pencil-outline"></i>
                                </button>
                                <button class="btn-action btn-delete" title="Supprimer"
                                        onclick="confirmDelete({{ pub.id }}, '{{ pub.titre|e('js') }}')">
                                    <i class="mdi mdi-trash-can-outline"></i>
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        {% endif %}
    </div>
</div>

{# ── Media Overlay ── #}
<div class="media-overlay" id="mediaOverlay">
    <button class="media-overlay-close" onclick="closeMedia()">&times;</button>
    <div id="mediaContent"></div>
    <div class="media-overlay-title" id="mediaTitle"></div>
</div>

{# ── Delete Confirm ── #}
<div class="confirm-overlay" id="deleteOverlay">
    <div class="confirm-box">
        <i class="mdi mdi-alert-circle-outline"></i>
        <h5>Confirmer la suppression</h5>
        <p id="deleteText">Voulez-vous vraiment supprimer cette publication ?</p>
        <button class="btn-cancel" onclick="closeDelete()">Annuler</button>
        <a id="deleteLink" href="#" class="btn-confirm-delete">Supprimer</a>
    </div>
</div>

{# ── Edit Overlays ── #}
{% for pub in publications %}
<div class="edit-overlay" id="editOverlay-{{ pub.id }}">
    <div class="edit-box">
        <div class="edit-box-header">
            <h5><i class="mdi mdi-pencil-outline"></i> Modifier la publication #{{ pub.id }}</h5>
            <button class="close-edit" onclick="closeEdit({{ pub.id }})">&times;</button>
        </div>
        <form action="{{ path('admin_forum_publication_edit', {id: pub.id}) }}" method="post" enctype="multipart/form-data">
            <div class="edit-box-body">
                <div class="form-group">
                    <label>Titre</label>
                    <input type="text" name="publication[titre]" class="form-control" value="{{ pub.titre }}" required>
                </div>
                <div class="form-group">
                    <label>Contenu</label>
                    <textarea name="publication[contenu]" class="form-control" rows="4" required>{{ pub.contenu }}</textarea>
                </div>
                <div class="form-group">
                    <label>Type de contenu</label>
                    <select name="publication[typecontenu]" class="form-control">
                        <option value="image" {{ pub.typecontenu.value == 'image' ? 'selected' }}>Image</option>
                        <option value="video" {{ pub.typecontenu.value == 'video' ? 'selected' }}>Vidéo</option>
                        <option value="texte" {{ pub.typecontenu.value == 'texte' ? 'selected' }}>Texte</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Statut</label>
                    <select name="publication[status]" class="form-control">
                        <option value="en attente" {{ pub.status.value == 'en attente' ? 'selected' }}>En attente</option>
                        <option value="publié" {{ pub.status.value == 'publié' ? 'selected' }}>Publié</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Fichier (Image ou Vidéo)</label>
                    {% if pub.fichier %}
                        <div class="current-file">
                            {% if pub.typecontenu.value == 'image' %}
                                <img src="{{ asset('uploads/publications/' ~ pub.fichier) }}" alt="">
                            {% else %}
                                <i class="mdi mdi-file-video-outline"></i>
                            {% endif %}
                            <span>{{ pub.fichier }}</span>
                        </div>
                    {% endif %}
                    <input type="file" name="publication[fichier]" class="form-control" accept="image/*,video/*">
                    <small style="color:#999; font-size:.78rem;">Laisser vide pour garder le fichier actuel.</small>
                </div>
            </div>
            <div class="edit-box-footer">
                <button type="button" class="btn-cancel-edit" onclick="closeEdit({{ pub.id }})">Annuler</button>
                <button type="submit" class="btn-save-edit"><i class="mdi mdi-content-save-outline"></i> Enregistrer</button>
            </div>
        </form>
    </div>
</div>
{% endfor %}
{% endblock %}

{% block javascripts %}
<script>
    function openMedia(type, url, title) {
        var c = document.getElementById('mediaContent');
        c.innerHTML = type === 'image'
            ? '<img src="'+url+'" alt="'+title+'">'
            : '<video src="'+url+'" controls autoplay style="outline:none"></video>';
        document.getElementById('mediaTitle').textContent = title;
        document.getElementById('mediaOverlay').classList.add('active');
        document.body.style.overflow = 'hidden';
    }
    function closeMedia() {
        document.getElementById('mediaOverlay').classList.remove('active');
        document.getElementById('mediaContent').innerHTML = '';
        document.body.style.overflow = '';
    }
    document.getElementById('mediaOverlay').addEventListener('click', function(e){ if(e.target===this) closeMedia(); });

    function confirmDelete(id, title) {
        document.getElementById('deleteText').textContent = 'Voulez-vous vraiment supprimer « '+title+' » ?';
        document.getElementById('deleteLink').href = '{{ path("admin_forum_publication_delete", {id:0}) }}'.replace('/0/', '/'+id+'/');
        document.getElementById('deleteOverlay').classList.add('active');
        document.body.style.overflow = 'hidden';
    }
    function closeDelete() {
        document.getElementById('deleteOverlay').classList.remove('active');
        document.body.style.overflow = '';
    }
    document.getElementById('deleteOverlay').addEventListener('click', function(e){ if(e.target===this) closeDelete(); });

    function openEdit(id) {
        document.getElementById('editOverlay-'+id).classList.add('active');
        document.body.style.overflow = 'hidden';
    }
    function closeEdit(id) {
        document.getElementById('editOverlay-'+id).classList.remove('active');
        document.body.style.overflow = '';
    }
    document.querySelectorAll('.edit-overlay').forEach(function(o){
        o.addEventListener('click', function(e){ if(e.target===this){ this.classList.remove('active'); document.body.style.overflow=''; }});
    });

    document.addEventListener('keydown', function(e){
        if(e.key==='Escape'){
            closeMedia(); closeDelete();
            document.querySelectorAll('.edit-overlay.active').forEach(function(el){ el.classList.remove('active'); });
            document.body.style.overflow='';
        }
    });

    /* ── Search & Sort ── */
    function clearSearch() {
        document.getElementById('pubSearchInput').value = '';
        document.getElementById('pubSearchForm').submit();
    }
    function applySort() {
        var form = document.getElementById('pubSearchForm');
        form.querySelector('input[name="sort"]').value = document.getElementById('pubSortSelect').value;
        form.submit();
    }
    function toggleDir() {
        var form = document.getElementById('pubSearchForm');
        var dirInput = form.querySelector('input[name="dir"]');
        dirInput.value = dirInput.value === 'ASC' ? 'DESC' : 'ASC';
        form.submit();
    }
    document.getElementById('pubSearchInput').addEventListener('keydown', function(e) {
        if (e.key === 'Enter') { e.preventDefault(); document.getElementById('pubSearchForm').submit(); }
    });
    document.getElementById('pubSearchInput').addEventListener('input', function() {
        var btn = document.querySelector('#pubSearchForm .clear-search');
        if (btn) btn.classList.toggle('visible', this.value.length > 0);
    });
</script>
{% endblock %}